<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta charset="UTF-8">
<title>QR Verification</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
    font-family: Arial;
    text-align: center;
}
.scanner {
    width: 80%;
    aspect-ratio: 1/1;
    margin: 1cm auto 0;
    border: 2px solid black;
    position: relative;
}
.scanner img {
    width: 100%;
    aspect-ratio: 1/1;
    object-fit: contain;
}
.buttons {
    width: 80%;
    margin: 0.3cm auto;
    display: flex;
    gap: 2%;
}
.choose-scan {
    width: 49%;
    height: 1cm;
    font-size: 0.45cm;
}
.approve {
    font-weight: bold;
    margin-top: 0.5cm;
    cursor: pointer;
}
#approvedList {
    display: none;
    margin-top: 10px;
}
</style>
</head>

<body>

<div class="scanner" id="scannerBox">
    <!-- Placeholder image -->
    <img id="placeholder" src="https://img.freepik.com/premium-vector/qr-code-scan-badge-icon-technology-instant-payment-tech-pay-method-without-money-vector-eps-10-isolated-white-background_399089-3451.jpg?semt=ais_hybrid&w=740&q=80"/></div>

<div class="buttons">
    <button class="choose-scan" onclick="chooseFile()">Choose File</button>
    <button class="choose-scan" onclick="toggleScan()">Scan</button>
</div>

<input type="file" id="fileInput" accept="image/*" hidden>

<h6 class="approve" onclick="showApproved()">A&nbsp;p&nbsp;p&nbsp;r&nbsp;o&nbsp;v&nbsp;e&nbsp;d&nbsp; L&nbsp;i&nbsp;s&nbsp;t</h6>

<div id="approvedList"></div>

<script>
const allowedQR = [
    "REG NO : REG-2455 | NAME : SWALIH K | PHONE : +91 9645169241",
    "REGISTER_OK",
    "QR_TEST_001"
];

let scanner;
let scanning = false;

/* ===== Toggle Camera Scan ===== */
function toggleScan() {
    if (!scanning) {
        Html5Qrcode.getCameras().then(cams => {
            if (cams.length === 0) {
                alert("Camera not available");
                return;
            }
            document.getElementById("placeholder").style.display = "none";
            scanner = new Html5Qrcode("scannerBox");
            scanner.start(
                cams[0].id,
                { fps: 10, qrbox: { width: 250, height: 250 } },
                onScanSuccess
            );
            scanning = true;
        }).catch(() => {
            alert("Camera permission required");
        });
    } else {
        scanner.stop();
        scanning = false;
        document.getElementById("placeholder").style.display = "block";
    }
}

/* ===== Scan Success ===== */
function onScanSuccess(text) {
    scanner.stop();
    scanning = false;
    document.getElementById("placeholder").style.display = "block";
    verifyQR(text);
}

/* ===== Choose File ===== */
function chooseFile() {
    document.getElementById("fileInput").click();
}

document.getElementById("fileInput").addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
        Html5QrcodeScanner.scanImage(reader.result, true)
            .then(verifyQR)
            .catch(() => alert("Invalid QR"));
    };
    reader.readAsDataURL(file);
});

/* ===== Verify QR ===== */
function verifyQR(data) {
    if (allowedQR.includes(data)) {
        saveApproved(data);
        alert("Registration Successful");
    } else {
        alert("QR Not Approved");
    }
}

/* ===== Storage ===== */
function saveApproved(value) {
    let list = JSON.parse(localStorage.getItem("approved")) || [];
    if (!list.includes(value)) {
        list.push(value);
        localStorage.setItem("approved", JSON.stringify(list));
    }
}

/* ===== Show Approved ===== */
function showApproved() {
    const box = document.getElementById("approvedList");
    const list = JSON.parse(localStorage.getItem("approved")) || [];

    box.innerHTML = "<b>Approved Entries</b><br>" +
        list.map(v => "âœ” " + v).join("<br>");

    box.style.display = box.style.display === "none" ? "block" : "none";
}
</script>

</body>
</html>
