<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
	<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>QR Verification with Approved List</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
    font-family: Arial;
    text-align: center;
    padding: 10px;
}

.scanner {
    width: 80%;
    aspect-ratio: 1/1;
    margin: 1cm auto 0;
    border: 2px solid black;
    position: relative;
    overflow: hidden;
}
    .scanner img {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: contain;
    image-rendering: auto;
    image-orientation: from-image;
}

.buttons {
    width: 80%;
    margin: 0.3cm auto;
    display: flex;
    gap: 2%;
}

.choose-scan {
    width: 49%;
    height: 1.2cm;
    font-size: 0.5cm;
    border: 2px solid black;
}

#flashBtn {
    position: absolute;
    top: 8px;
    right: 8px;
    z-index: 9999;   /* üëà ‡¥è‡¥±‡µç‡¥±‡¥µ‡µÅ‡¥Ç ‡¥™‡µç‡¥∞‡¥ß‡¥æ‡¥®‡¥™‡µç‡¥™‡µÜ‡¥ü‡µç‡¥ü‡¥§‡µç */
    background: rgba(255,255,255,0.85);
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: none;
}

#resultBox {
    width: 74%;
    margin: 0.5cm auto;
    padding: 12px;
    border-radius: 8px;
    display: none;
    font-size: 18px;
    font-weight: bold;
}

.success { color: green; border: 2px solid green; }
.fail { color: red; border: 2px solid red; }

/* Approved List Styling */
#approvedListBtn {
    width: 80%;
    margin: 0.5cm auto;
    padding: 12px;
    font-size: 1em;
    border-radius: 8px;
    border: 2px solid #555;
    cursor: pointer;
    background: #f0f0f0;
}

#approvedList {
    width: 74%;
    margin: 0.5cm auto;
    padding: 10px;
    border: 2px solid #555;
    border-radius: 8px;
    display: none;
    text-align: left;
    max-height: 300px;
    overflow-y: auto;
    background: #f9f9f9;
}

#approvedList h3 {
    margin-top: 0;
}

#approvedUl li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    margin-left: -1.11cm;
    border-bottom: 1px solid #ddd;
}
#scannerBox video {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover; /* contain ‡¥µ‡µá‡¥£‡µç‡¥ü, cover ‡¥Ü‡¥£‡µç ‡¥®‡¥≤‡µç‡¥≤‡¥§‡µç scan ‡¥®‡µç */
} 

.removeBtn {
    color: ;
    cursor: pointer;
    font-weight: bold;
}
</style>
</head>

<body>

<h2>QR Verification</h2>

<div class="scanner" id="scannerBox">
    <img id="placeholder"
         src="https://img.freepik.com/premium-vector/qr-code-scan-badge-icon-technology-instant-payment-tech-pay-method-without-money-vector-eps-10-isolated-white-background_399089-3451.jpg">
    <button id="flashBtn">‚ö°</button>
</div>

<div class="buttons">
    <button class="choose-scan" onclick="chooseFile()">üìÅ</button>
    <button class="choose-scan" id="scanBtn" onclick="toggleScan()">Scan</button>
</div>

<!-- Approved List Toggle Button -->
<button id="approvedListBtn" onclick="toggleApprovedList()">Approved List</button>

<div id="approvedList">
    <h3>Approved Registrations:</h3>
    <ul id="approvedUl"></ul>
</div>

<input type="file" id="fileInput" accept="image/*" hidden>

<div id="resultBox"></div>
<audio id="successBeep">
    <source src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" type="audio/ogg">
</audio>
<script>
const allowedQR = [
    "REG NO : REG-2455 | NAME : SWALIH K | PHONE : +91 9645169241",
    "upi://pay?pa=qr.jamia24@sib&pn=JAMIA%MARKAZU%SSAQUAFATHISSUNNIYYA&mc=8299&cu=INR&orgid=159059&mode=02&sign=MEUCIC/8do+JbE1e6CO29tussG/4fWTRAkl3R3HvVTj3GQ7XAiEAhJWqWv2XtDiRoD4Q2FJ9TDCDpBMZXMrKIhNV238M5q4=",
    "QR_TEST_001"
];

let scanner = null;
let scanning = false;
let currentCameraId = null;
let flashOn = false;
let approvedRegistrations = JSON.parse(localStorage.getItem('approvedRegs')) || [];

/* ---------- CAMERA SCAN ---------- */
async function toggleScan() {
    const btn = document.getElementById("scanBtn");
    const img = document.getElementById("placeholder");

    if (!scanning) {
        img.style.display = "none";
        try {
            const cameras = await Html5Qrcode.getCameras();
            const backCam = cameras.find(cam => /back|rear/i.test(cam.label)) || cameras[0];
            currentCameraId = backCam.id;

            if (!scanner) scanner = new Html5Qrcode("scannerBox");

            await scanner.start(
    currentCameraId,
    {
        fps: 15,
        qrbox: { width: 280, height: 280 }
    },
    decodedText => verifyQR(decodedText)
);
            scanning = true;
            btn.innerText = "Stop";
        } catch(e) {
            showResult("Camera permission required", false);
            img.style.display = "block";
        }
    } else {
    await scanner.stop();
    scanning = false;
    btn.innerText = "Scan";

    const img = document.getElementById("placeholder");
    img.style.display = "block";   // üëà placeholder ‡¥§‡¥ø‡¥∞‡¥ø‡¥ï‡µÜ
}
}

/* ---------- FLASH ---------- */
document.getElementById("flashBtn").addEventListener("click", async () => {
    if (!scanner || !scanning) {
        alert("Scan start ‡¥ö‡µÜ‡¥Ø‡µç‡¥§‡¥§‡¥ø‡¥®‡µç ‡¥∂‡µá‡¥∑‡¥Ç flash ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥Ç");
        return;
    }

    try {
        flashOn = !flashOn;
        await scanner.applyVideoConstraints({
            advanced: [{ torch: flashOn }]
        });
    } catch (e) {
        alert("Flash not supported on this device");
        flashOn = false;
    }
});

/* ---------- GALLERY ---------- */
function chooseFile() {
    document.getElementById("fileInput").click();
}

document.getElementById("fileInput").addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;

    const img = document.getElementById("placeholder");
    img.style.display = "block";

    const reader = new FileReader();
    reader.onload = e => img.src = e.target.result;
    reader.readAsDataURL(file);

    const imageScanner = new Html5Qrcode("scannerBox");

    imageScanner.scanFile(file, true)
        .then(decodedText => verifyQR(decodedText))
        .catch(() => showResult("QR Code not detected", false))
        .finally(() => {
            img.style.display = "block";   // ‚úÖ placeholder always visible
        });
});

/* ---------- VERIFY QR ---------- */
function verifyQR(data) {
    if (allowedQR.includes(data)) {
        showResult("‚úÖ Registration Successful", true);
        saveApproved(data);
    } else {
        showResult("‚ùå QR Not Approved", false);
    }
}

/* ---------- SHOW RESULT ---------- */
function showResult(message, success) {
    const box = document.getElementById("resultBox");
    box.style.display = "block";
    box.className = success ? "success" : "fail";
    box.innerHTML = message;
}

/* ---------- SAVE TO APPROVED LIST ---------- */
function saveApproved(qrData) {
    let regMatch = qrData.match(/REG NO\s*:\s*([^|]+)/i);
    let nameMatch = qrData.match(/NAME\s*:\s*([^|]+)/i);
    if (!regMatch || !nameMatch) return;

    let regNo = regMatch[1].trim();
    let name = nameMatch[1].trim();

    let exists = approvedRegistrations.find(r => r.regNo === regNo);
    if (!exists) {
        approvedRegistrations.push({regNo, name});
        localStorage.setItem('approvedRegs', JSON.stringify(approvedRegistrations));
        populateApprovedList(); // update list if visible
    }
}

/* ---------- TOGGLE APPROVED LIST ---------- */
function toggleApprovedList() {
    const listDiv = document.getElementById("approvedList");
    const btn = document.getElementById("approvedListBtn");

    if (listDiv.style.display === "none" || listDiv.style.display === "") {
        populateApprovedList();
        listDiv.style.display = "block";
        btn.innerText = "Approved List";
    } else {
        listDiv.style.display = "none";
        btn.innerText = "Approved List";
    }
}

/* ---------- POPULATE APPROVED LIST WITH SERIAL AND REMOVE ---------- */
function populateApprovedList() {
    const ul = document.getElementById("approvedUl");
    ul.innerHTML = "";
    if (approvedRegistrations.length === 0) {
        ul.innerHTML = "<li>No approved registrations yet.</li>";
    } else {
        approvedRegistrations.forEach((item, index) => {
            const li = document.createElement("li");
            li.innerHTML = `${index + 1}. &nbsp;${item.regNo} &nbsp;&nbsp;&nbsp;${item.name} <span class="removeBtn" onclick="removeApproved(${index})"><i style="color:black;" class="fa-solid fa-trash"></i>  </span>`;
            ul.appendChild(li);
        });
    }
}

/* ---------- REMOVE APPROVED ---------- */
function removeApproved(index) {
    approvedRegistrations.splice(index, 1);
    localStorage.setItem('approvedRegs', JSON.stringify(approvedRegistrations));
    populateApprovedList();
}

function verifyQR(data) {
    if (allowedQR.includes(data)) {
        showResult("‚úÖ Registration Successful", true);

        document.getElementById("successBeep").play(); // üîä beep
        saveApproved(data);

    } else {
        showResult("‚ùå QR Not Approved", false);
    }
}
</script>

</body>
	</html>
