<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
	<link rel="stylesheet"
 href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>QR Verification with Approved List</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
    font-family: Arial;
    text-align: center;
    padding: 10px;
}

.scanner {
    width: 80%;
    aspect-ratio: 1/1;
    margin: 1cm auto 0;
    border: 2px solid black;
    position: relative;
    overflow: hidden;
}
    .scanner img {
    max-width: 100%;
    max-height: 100%;
    width: auto;
    height: auto;
    object-fit: contain;
    image-rendering: auto;
    image-orientation: from-image;
}

.buttons {
    width: 80%;
    margin: 0.3cm auto;
    display: flex;
    gap: 2%;
}

.choose-scan {
    width: 49%;
    height: 1.2cm;
    font-size: 0.5cm;
    border: 2px solid black;
}

#flashBtn {
    position: absolute;
    top: 8px;
    right: 8px;
    z-index: 9999;
    background: rgba(255,255,255,0.85);
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    display: none;   /* start ‡¥∏‡¥Æ‡¥Ø‡¥§‡µç‡¥§‡µç JS ‡¥µ‡¥¥‡¥ø show ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥Ç */
}

#resultBox {
    width: 74%;
    margin: 0.5cm auto;
    padding: 12px;
    border-radius: 8px;
    display: none;
    font-size: 18px;
    font-weight: bold;
}

.success { color: green; border: 2px solid green; }
.fail { color: red; border: 2px solid red; }

/* Approved List Styling */
#approvedListBtn {
    width: 80%;
    margin: 0.5cm auto;
    padding: 12px;
    font-size: 1em;
    border-radius: 8px;
    border: 2px solid #555;
    cursor: pointer;
    background: #f0f0f0;
}

#approvedList {
    width: 74%;
    margin: 0.5cm auto;
    padding: 10px;
    border: 2px solid #555;
    border-radius: 8px;
    display: none;
    text-align: left;
    max-height: 300px;
    overflow-y: auto;
    background: #f9f9f9;
}

#approvedList h3 {
    margin-top: 0;
}

#approvedUl li {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 4px 0;
    margin-left: -1.11cm;
    border-bottom: 1px solid #ddd;
}
#scannerBox video {
    width: 100% !important;
    height: 100% !important;
    object-fit: cover; /* contain —Ä‚î§‚ï°—Ä‚ï°–ó—Ä‚î§–≥—Ä‚ï°–ù—Ä‚î§–Ø, cover —Ä‚î§–ñ—Ä‚î§–≥—Ä‚ï°–ù —Ä‚î§–∏—Ä‚î§‚ñì—Ä‚ï°–ù—Ä‚î§‚ñì—Ä‚î§–¥—Ä‚ï°–ù scan —Ä‚î§–∏—Ä‚ï°–ù */
} 

.removeBtn {
    color: ;
    cursor: pointer;
    font-weight: bold;
}
</style>
</head>

<body>

<h2>QR Verification</h2>

<div class="scanner" id="scannerBox">
    <img id="placeholder"
         src="https://img.freepik.com/premium-vector/qr-code-scan-badge-icon-technology-instant-payment-tech-pay-method-without-money-vector-eps-10-isolated-white-background_399089-3451.jpg">
    <button id="flashBtn">üí°</button>
</div>

<div class="buttons">
    <button class="choose-scan" onclick="chooseFile()">–Å–Ø–£–ë</button>
    <button class="choose-scan" id="scanBtn" onclick="toggleScan()">Scan</button>
</div>

<!-- Approved List Toggle Button -->
<button id="approvedListBtn" onclick="toggleApprovedList()">Approved List</button>

<div id="approvedList">
    <h3>Approved Registrations:</h3>
    <ul id="approvedUl"></ul>
</div>

<input type="file" id="fileInput" accept="image/*" hidden>

<div id="resultBox"></div>
<audio id="successBeep">
    <source src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" type="audio/ogg">
</audio>
<script>
const allowedQR = [
    "REG NO : REG-2451 | NAME : MUSHTHAQ PK",
"REG NO : REG-2452 | NAME : RASHID K",
"REG NO : REG-2453 | NAME : MUKLIS KC",
"REG NO : REG-2454 | NAME : FAHEEM C",
"REG NO : REG-2455 | NAME : SWALIH K",
"REG NO : REG-2456 | NAME : SALEETH AK",
"REG NO : REG-2457 | NAME : SAHLUDEEN KC",
"REG NO : REG-2458 | NAME : SHAMIL AK",
"REG NO : REG-2459 | NAME : JALEEL K",
"REG NO : REG-2460 | NAME : YASIR VC",
"REG NO : REG-2461 | NAME : SHADIL AK",
"REG NO : REG-2462 | NAME : NAJEEB KP",
"REG NO : REG-2463 | NAME : NIYAS CP",
"REG NO : REG-2464 | NAME : NUHMAN VC",
"REG NO : REG-2465 | NAME : SWALIH CK",
"REG NO : REG-2466 | NAME : SAHL CT",
"REG NO : REG-2467 | NAME : RUWAIZ K",
"REG NO : REG-2468 | NAME : RABEEH CT",
"REG NO : REG-2469 | NAME : FAVAS CKC",
"REG NO : REG-2470 | NAME : HUWAIZ AK",
"REG NO : REG-2471 | NAME : RABEEH VC",
"REG NO : REG-2472 | NAME : SAFVAN K",
"REG NO : REG-2473 | NAME : NASEEH K",
"REG NO : REG-2474 | NAME : SINAN PK",
"REG NO : REG-2475 | NAME : HUBAIL VC",
"REG NO : REG-2476 | NAME : SHUHAIB MP",
"REG NO : REG-2477 | NAME : MINHAJ KP",
"REG NO : REG-2478 | NAME : HISHAL PK",
"REG NO : REG-2479 | NAME : SHIFIN AK",
"REG NO : REG-2480 | NAME : MIDLAJ A",
"REG NO : REG-2481 | NAME : MIDLAJ P",
"REG NO : REG-2482 | NAME : FARHAN C",
"REG NO : REG-2483 | NAME : JASEEM CP",
"REG NO : REG-2484 | NAME : HISHAM KP",
"REG NO : REG-2485 | NAME : SINAN AP",
"REG NO : REG-2486 | NAME : NASEEM VC",
"REG NO : REG-2487 | NAME : SAHL MP",
"REG NO : REG-2488 | NAME : ASLAM VC",
"REG NO : REG-2489 | NAME : IHTHISHAAM KC",
"REG NO : REG-2490 | NAME : AJWAD P",
"REG NO : REG-2491 | NAME : RAFEEH VC",
"REG NO : REG-2492 | NAME : SHAMSUL FALAH KP",
"REG NO : REG-2493 | NAME : WADOOD KP",
"REG NO : REG-2494 | NAME : AJHAD P",
"REG NO : REG-2495 | NAME : NAJAH KP"
];

let scanner = null;
let scanning = false;
let currentCameraId = null;
let flashOn = false;
let approvedRegistrations = JSON.parse(localStorage.getItem('approvedRegs')) || [];

/* ---------- CAMERA SCAN ---------- */
async function toggleScan() {
    if (scanning) return; // ‡¥µ‡µÄ‡¥£‡µç‡¥ü‡µÅ‡¥Ç Scan ‡¥Ö‡¥Æ‡µº‡¥§‡µç‡¥§‡¥ø‡¥Ø‡¥æ‡µΩ ‡¥í‡¥®‡µç‡¥®‡µÅ‡¥Ç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥∞‡µÅ‡¥§‡µç

    const img = document.getElementById("placeholder");
    const flashBtn = document.getElementById("flashBtn");

    img.style.display = "none";

    try {
        const cameras = await Html5Qrcode.getCameras();
        const backCam = cameras.find(cam => /back|rear/i.test(cam.label)) || cameras[0];
        currentCameraId = backCam.id;

        if (!scanner) scanner = new Html5Qrcode("scannerBox");

        await scanner.start(
            currentCameraId,
            {
                fps: 15,
                qrbox: { width: 280, height: 280 }
            },
            decodedText => verifyQR(decodedText)
        );

        scanning = true;

        // ‚úÖ Flash button show
        flashBtn.style.display = "block";

    } catch (e) {
        showResult("Camera permission required", false);
        img.style.display = "block";
    }
}

/* ---------- FLASH ---------- */
document.getElementById("flashBtn").addEventListener("click", async () => {
    if (!scanner || !scanning) {
        alert("Scan ‡¥Ü‡¥¶‡µç‡¥Ø‡¥Ç start ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥£‡¥Ç");
        return;
    }

    try {
        flashOn = !flashOn;

        await scanner.applyVideoConstraints({
            advanced: [{ torch: flashOn }]
        });

        document.getElementById("flashBtn").innerHTML =
            flashOn ? "üî¶" : "üí°";

    } catch (e) {
        alert("Flash not supported on this device");
        flashOn = false;
    }
});

/* page refresh ‡¥Ü‡¥ï‡µÅ‡¥Æ‡µç‡¥™‡µã‡µæ flash off */
window.addEventListener("beforeunload", () => {
    flashOn = false;
});

/* ---------- GALLERY ---------- */
function chooseFile() {
    document.getElementById("fileInput").click();
}

document.getElementById("fileInput").addEventListener("change", e => {
    const file = e.target.files[0];
    if (!file) return;

    const img = document.getElementById("placeholder");
    img.style.display = "block";

    const reader = new FileReader();
    reader.onload = e => img.src = e.target.result;
    reader.readAsDataURL(file);

    const imageScanner = new Html5Qrcode("scannerBox");

    imageScanner.scanFile(file, true)
        .then(decodedText => verifyQR(decodedText))
        .catch(() => showResult("QR Code not detected", false))
        .finally(() => {
            img.style.display = "block";   // —Ç–¨–ï placeholder always visible
        });
});

/* ---------- VERIFY QR ---------- */
function verifyQR(data) {
    if (allowedQR.includes(data)) {
        showResult("‚úî Registration Successful", true);
        document.getElementById("successBeep").play();
        saveApproved(data);
    } else {
        showResult("‚úñ QR Not Approved", false);
    }
}

/* ---------- SHOW RESULT ---------- */
function showResult(message, success) {
    const box = document.getElementById("resultBox");
    box.style.display = "block";
    box.className = success ? "success" : "fail";
    box.innerHTML = message;
}

/* ---------- SAVE TO APPROVED LIST ---------- */
function saveApproved(qrData) {
    let regMatch = qrData.match(/REG NO\s*:\s*([^|]+)/i);
    let nameMatch = qrData.match(/NAME\s*:\s*([^|]+)/i);
    if (!regMatch || !nameMatch) return;

    let regNo = regMatch[1].trim();
    let name = nameMatch[1].trim();

let exists = approvedRegistrations.some(r => r.regNo === regNo);
if (exists) return;

approvedRegistrations.push({ regNo, name });

approvedRegistrations.sort((a, b) => {
    const numA = parseInt(a.regNo.replace(/\D/g, ""));
    const numB = parseInt(b.regNo.replace(/\D/g, ""));
    return numA - numB;
});

localStorage.setItem('approvedRegs', JSON.stringify(approvedRegistrations));
populateApprovedList();
    }
}

/* ---------- TOGGLE APPROVED LIST ---------- */
function toggleApprovedList() {
    const listDiv = document.getElementById("approvedList");
    const btn = document.getElementById("approvedListBtn");

    if (listDiv.style.display === "none" || listDiv.style.display === "") {
        populateApprovedList();
        listDiv.style.display = "block";
        btn.innerText = "Approved List";
    } else {
        listDiv.style.display = "none";
        btn.innerText = "Approved List";
    }
}

/* ---------- POPULATE APPROVED LIST WITH SERIAL AND REMOVE ---------- */
function populateApprovedList() {
    const ul = document.getElementById("approvedUl");
    ul.innerHTML = "";
    if (approvedRegistrations.length === 0) {
        ul.innerHTML = "<li>No approved registrations yet.</li>";
    } else {
        approvedRegistrations.forEach((item, index) => {
            const li = document.createElement("li");
            li.innerHTML = `${index + 1}. &nbsp;${item.regNo} &nbsp;&nbsp;&nbsp;${item.name} <span class="removeBtn" onclick="removeApproved(${index})"><i style="color:black;" class="fa-solid fa-trash"></i>  </span>`;
            ul.appendChild(li);
        });
    }
}

/* ---------- REMOVE APPROVED ---------- */
function removeApproved(index) {
    approvedRegistrations.splice(index, 1);
    localStorage.setItem('approvedRegs', JSON.stringify(approvedRegistrations));
    populateApprovedList();
}

function verifyQR(data) {
    if (allowedQR.includes(data)) {
        showResult("‚úî Registration Successful", true);
        document.getElementById("successBeep").play();
        saveApproved(data);
    } else {
        showResult("‚úñ QR Not Approved", false);
    }
}
</script>

</body>
</html>
